{% extends "base.html" %}

{% block title %}Scripts - Control Panel{% endblock %}

{% block content %}

<!-- Help Banner -->
<div class="glass rounded-xl p-4 border border-blue-500/30 bg-blue-500/10 mb-6">
  <div class="flex items-start gap-4">
    <div class="text-blue-400 text-2xl">
      <i class="fas fa-info-circle"></i>
    </div>
    <div class="flex-1">
      <h3 class="font-bold text-blue-400 mb-2">Quick Guide</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-300">
        <div class="flex items-start gap-2">
          <span class="px-2 py-1 bg-gradient-to-r from-blue-500 to-purple-600 rounded text-xs font-bold">RUN</span>
          <span>Execute script <strong>locally</strong> on this machine</span>
        </div>
        <div class="flex items-start gap-2">
          <span class="px-2 py-1 bg-green-500/30 border border-green-500 rounded text-xs font-bold text-green-400">DEPLOY</span>
          <span>Send script to <strong>remote VMs</strong> via SSH</span>
        </div>
      </div>
    </div>
    <button onclick="this.parentElement.parentElement.style.display='none'" class="text-gray-400 hover:text-gray-200">
      <i class="fas fa-times"></i>
    </button>
  </div>
</div>

<!-- Stats Bar -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
  <div class="glass rounded-xl p-6 border border-gray-700">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-gray-400 text-sm">Total Scripts</p>
        <p class="text-3xl font-bold text-blue-400">{{ scripts|length }}</p>
      </div>
      <div class="bg-blue-500/20 p-3 rounded-lg">
        <i class="fas fa-file-code text-blue-400 text-2xl"></i>
      </div>
    </div>
  </div>
  
  <div class="glass rounded-xl p-6 border border-gray-700">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-gray-400 text-sm">PowerShell</p>
        <p class="text-3xl font-bold text-purple-400">{{ scripts|selectattr('ext', 'equalto', '.ps1')|list|length }}</p>
      </div>
      <div class="bg-purple-500/20 p-3 rounded-lg">
        <i class="fab fa-windows text-purple-400 text-2xl"></i>
      </div>
    </div>
  </div>
  
  <div class="glass rounded-xl p-6 border border-gray-700">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-gray-400 text-sm">Python</p>
        <p class="text-3xl font-bold text-green-400">{{ scripts|selectattr('ext', 'equalto', '.py')|list|length }}</p>
      </div>
      <div class="bg-green-500/20 p-3 rounded-lg">
        <i class="fab fa-python text-green-400 text-2xl"></i>
      </div>
    </div>
  </div>
  
  <div class="glass rounded-xl p-6 border border-gray-700">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-gray-400 text-sm">Shell Scripts</p>
        <p class="text-3xl font-bold text-yellow-400">{{ scripts|selectattr('ext', 'equalto', '.sh')|list|length }}</p>
      </div>
      <div class="bg-yellow-500/20 p-3 rounded-lg">
        <i class="fas fa-terminal text-yellow-400 text-2xl"></i>
      </div>
    </div>
  </div>
</div>

<!-- Search & Filter -->
<div class="glass rounded-xl p-6 border border-gray-700 mb-6">
  <div class="flex flex-col md:flex-row gap-4">
    <div class="flex-1 relative">
      <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
      <input 
        type="text" 
        id="filter" 
        placeholder="Search scripts by name or path..." 
        oninput="applyFilter()"
        class="w-full pl-12 pr-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-100 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20 transition-all"
      />
    </div>
    <div class="flex gap-2">
      <select id="type-filter" onchange="applyFilter()" class="px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-gray-100 focus:outline-none focus:border-blue-500">
        <option value="">All Types</option>
        <option value=".ps1">PowerShell (.ps1)</option>
        <option value=".py">Python (.py)</option>
        <option value=".sh">Shell (.sh)</option>
        <option value=".bat">Batch (.bat)</option>
        <option value=".cmd">Command (.cmd)</option>
      </select>
      <button onclick="document.getElementById('filter').value=''; document.getElementById('type-filter').value=''; applyFilter();" 
              class="px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg hover:bg-gray-700 transition-colors">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>
  <div class="mt-4 flex items-center justify-between text-sm">
    <span class="text-gray-400">
      <span id="visible-count">{{ scripts|length }}</span> of {{ scripts|length }} scripts
    </span>
    <div class="flex gap-2">
      <button onclick="setView('grid')" id="grid-view-btn" class="px-3 py-1 rounded hover:bg-gray-800 transition-colors">
        <i class="fas fa-th"></i>
      </button>
      <button onclick="setView('list')" id="list-view-btn" class="px-3 py-1 rounded bg-gray-800">
        <i class="fas fa-list"></i>
      </button>
    </div>
  </div>
</div>

<!-- Scripts Grid/List -->
<div id="scripts-container" class="grid grid-cols-1 gap-4">
  {% for s in scripts %}
  <div class="script-item glass rounded-xl border border-gray-700 hover:border-blue-500/50 transition-all duration-300 group" data-row data-path="{{ s.relpath }}" data-type="{{ s.ext }}">
    <div class="p-6">
      <div class="flex items-start justify-between">
        <!-- Script Info -->
        <div class="flex items-start space-x-4 flex-1">
          <!-- Icon -->
          <div class="p-3 rounded-lg {% if s.ext == '.ps1' %}bg-purple-500/20{% elif s.ext == '.py' %}bg-green-500/20{% elif s.ext == '.sh' %}bg-yellow-500/20{% else %}bg-blue-500/20{% endif %}">
            {% if s.ext == '.ps1' %}
              <i class="fab fa-windows text-purple-400 text-2xl"></i>
            {% elif s.ext == '.py' %}
              <i class="fab fa-python text-green-400 text-2xl"></i>
            {% elif s.ext == '.sh' %}
              <i class="fas fa-terminal text-yellow-400 text-2xl"></i>
            {% else %}
              <i class="fas fa-file-code text-blue-400 text-2xl"></i>
            {% endif %}
          </div>
          
          <!-- Details -->
          <div class="flex-1 min-w-0">
            <h3 class="text-lg font-semibold text-gray-100 group-hover:text-blue-400 transition-colors truncate path">
              {{ s.name }}
            </h3>
            <p class="text-sm text-gray-400 mt-1 truncate">{{ s.relpath }}</p>
            <div class="flex items-center gap-4 mt-3 text-xs text-gray-500">
              <span class="flex items-center gap-1">
                <i class="fas fa-tag"></i>
                {{ s.ext }}
              </span>
              <span class="flex items-center gap-1">
                <i class="fas fa-clock"></i>
                Modified: {{ s.mtime|int }}
              </span>
            </div>
          </div>
        </div>
        
        <!-- Actions -->
        <div class="flex items-center gap-2 ml-4">
          <a href="/deploy/{{ s.relpath }}" 
             class="px-4 py-2 bg-green-500/20 border border-green-500/50 text-green-400 hover:bg-green-500/30 rounded-lg transition-all duration-200 transform hover:scale-105"
             title="Deploy script to remote VMs via SSH">
            <i class="fas fa-cloud-upload-alt mr-2"></i>Deploy
          </a>
          <form method="post" action="/run" onsubmit="return confirmRun('{{ s.name }}', this)" class="inline-block">
            <input type="hidden" name="path" value="{{ s.relpath }}" />
            <button type="submit" 
                    class="px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-600 hover:from-blue-600 hover:to-purple-700 rounded-lg transition-all duration-200 transform hover:scale-105 group-hover:shadow-lg group-hover:shadow-blue-500/50"
                    title="Run script locally on this machine">
              <i class="fas fa-play mr-2"></i>Run
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<!-- Empty State -->
<div id="empty-state" class="hidden text-center py-16">
  <div class="glass rounded-xl p-12 border border-gray-700 inline-block">
    <i class="fas fa-search text-gray-600 text-6xl mb-4"></i>
    <p class="text-gray-400 text-lg">No scripts found matching your search</p>
    <button onclick="document.getElementById('filter').value=''; document.getElementById('type-filter').value=''; applyFilter();" 
            class="mt-4 px-6 py-2 bg-blue-500 hover:bg-blue-600 rounded-lg transition-colors">
      Clear Filters
    </button>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let currentView = 'list';

function applyFilter() {
  const searchQuery = document.getElementById('filter').value.toLowerCase();
  const typeFilter = document.getElementById('type-filter').value;
  const items = document.querySelectorAll('[data-row]');
  let visibleCount = 0;
  
  items.forEach(item => {
    const path = item.querySelector('.path').textContent.toLowerCase();
    const fullPath = item.dataset.path.toLowerCase();
    const type = item.dataset.type;
    
    const matchesSearch = path.includes(searchQuery) || fullPath.includes(searchQuery);
    const matchesType = !typeFilter || type === typeFilter;
    
    if (matchesSearch && matchesType) {
      item.style.display = '';
      visibleCount++;
    } else {
      item.style.display = 'none';
    }
  });
  
  document.getElementById('visible-count').textContent = visibleCount;
  document.getElementById('empty-state').classList.toggle('hidden', visibleCount > 0);
}

function setView(view) {
  currentView = view;
  const container = document.getElementById('scripts-container');
  const gridBtn = document.getElementById('grid-view-btn');
  const listBtn = document.getElementById('list-view-btn');
  
  if (view === 'grid') {
    container.className = 'grid grid-cols-1 md:grid-cols-2 gap-4';
    gridBtn.classList.add('bg-gray-800');
    listBtn.classList.remove('bg-gray-800');
  } else {
    container.className = 'grid grid-cols-1 gap-4';
    gridBtn.classList.remove('bg-gray-800');
    listBtn.classList.add('bg-gray-800');
  }
}

function confirmRun(scriptName, form) {
  const confirmed = confirm(
    `ðŸš€ Run Script Locally\n\n` +
    `Script: ${scriptName}\n` +
    `Location: This machine (local)\n\n` +
    `This will execute the script on your local computer and show the results.\n\n` +
    `Continue?`
  );
  if (confirmed) {
    // Show loading indicator
    const btn = form.querySelector('button');
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Running...';
    btn.disabled = true;
  }
  return confirmed;
}

// Auto-refresh script list every 30 seconds
let autoRefreshInterval;
function startAutoRefresh() {
  autoRefreshInterval = setInterval(() => {
    // Only refresh if no modal/dialog is open
    if (!document.querySelector('[role="dialog"]')) {
      location.reload();
    }
  }, 30000);
}

// startAutoRefresh();
</script>
{% endblock %}
