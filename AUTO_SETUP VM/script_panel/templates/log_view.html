{% extends "base.html" %}

{% block title %}Log: {{ run_id }} - Control Panel{% endblock %}

{% block content %}
<!-- Header -->
<div class="mb-6">
  <div class="flex items-center justify-between mb-4">
    <div class="flex items-center gap-4">
      <a href="/logs" class="px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg hover:bg-gray-700 transition-colors">
        <i class="fas fa-arrow-left mr-2"></i>Back
      </a>
      <div>
        <h2 class="text-2xl font-bold text-gray-100 font-mono">{{ run_id }}</h2>
        <p class="text-gray-400 text-sm mt-1">Execution Log</p>
      </div>
    </div>
    
    <div class="flex items-center gap-2">
      <button onclick="toggleAutoRefresh()" id="auto-refresh-btn" class="px-4 py-2 bg-green-500/20 border border-green-500/50 text-green-400 rounded-lg hover:bg-green-500/30 transition-colors">
        <i class="fas fa-sync-alt mr-2"></i>Auto-refresh ON
      </button>
      <button onclick="copyLog()" class="px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg hover:bg-gray-700 transition-colors">
        <i class="fas fa-copy mr-2"></i>Copy
      </button>
      <a href="/logs/{{ run_id }}/raw" target="_blank" class="px-4 py-2 bg-gray-800 border border-gray-700 rounded-lg hover:bg-gray-700 transition-colors">
        <i class="fas fa-external-link-alt mr-2"></i>Raw
      </a>
      <button onclick="downloadLog()" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 rounded-lg transition-colors">
        <i class="fas fa-download mr-2"></i>Download
      </button>
    </div>
  </div>

  <!-- Status Info -->
  {% if meta %}
  <div class="glass rounded-xl border border-gray-700 p-6">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div>
        <p class="text-gray-400 text-sm mb-2">Status</p>
        <div class="flex items-center gap-2">
          {% if meta.status == 'running' %}
            <span class="px-3 py-1 bg-blue-500/20 border border-blue-500/50 text-blue-400 rounded-lg text-sm font-semibold flex items-center gap-2">
              <i class="fas fa-spinner fa-spin"></i>
              RUNNING
            </span>
          {% elif meta.status == 'success' %}
            <span class="px-3 py-1 bg-green-500/20 border border-green-500/50 text-green-400 rounded-lg text-sm font-semibold flex items-center gap-2">
              <i class="fas fa-check-circle"></i>
              SUCCESS
            </span>
          {% elif meta.status == 'failed' %}
            <span class="px-3 py-1 bg-red-500/20 border border-red-500/50 text-red-400 rounded-lg text-sm font-semibold flex items-center gap-2">
              <i class="fas fa-times-circle"></i>
              FAILED
            </span>
          {% else %}
            <span class="px-3 py-1 bg-yellow-500/20 border border-yellow-500/50 text-yellow-400 rounded-lg text-sm font-semibold flex items-center gap-2">
              <i class="fas fa-exclamation-triangle"></i>
              {{ meta.status|upper }}
            </span>
          {% endif %}
          {% if meta.returncode is not none %}
            <span class="text-gray-400 text-sm">Exit Code: <span class="font-mono">{{ meta.returncode }}</span></span>
          {% endif %}
        </div>
      </div>
      
      <div>
        <p class="text-gray-400 text-sm mb-2">Script Path</p>
        <p class="text-gray-200 font-mono text-sm truncate">{{ meta.path }}</p>
      </div>
      
      <div>
        <p class="text-gray-400 text-sm mb-2">Command</p>
        <p class="text-gray-200 font-mono text-xs break-all">{{ ' '.join(meta.cmd) }}</p>
      </div>
    </div>
    
    {% if meta.start %}
    <div class="mt-4 pt-4 border-t border-gray-700">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
        <div>
          <span class="text-gray-400">Started:</span>
          <span class="text-gray-200 ml-2">{{ meta.start|round(2) }}</span>
        </div>
        {% if meta.end %}
        <div>
          <span class="text-gray-400">Ended:</span>
          <span class="text-gray-200 ml-2">{{ meta.end|round(2) }}</span>
        </div>
        <div>
          <span class="text-gray-400">Duration:</span>
          <span class="text-green-400 ml-2 font-semibold">{{ (meta.end - meta.start)|round(2) }}s</span>
        </div>
        {% else %}
        <div>
          <span class="text-gray-400">Duration:</span>
          <span class="text-blue-400 ml-2 font-semibold">
            <i class="fas fa-spinner fa-spin"></i>
            Running...
          </span>
        </div>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>
  {% endif %}
</div>

<!-- Log Output -->
<div class="glass rounded-xl border border-gray-700 overflow-hidden">
  <div class="bg-gray-900/50 px-6 py-3 border-b border-gray-700 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <i class="fas fa-terminal text-blue-400"></i>
      <span class="text-gray-300 font-semibold">Console Output</span>
      <span id="log-size" class="text-gray-500 text-sm">0 bytes</span>
    </div>
    <div class="flex items-center gap-2">
      <button onclick="scrollToBottom()" class="px-3 py-1 bg-gray-800 rounded hover:bg-gray-700 transition-colors text-sm">
        <i class="fas fa-arrow-down mr-1"></i>Scroll to Bottom
      </button>
      <button onclick="clearLogDisplay()" class="px-3 py-1 bg-gray-800 rounded hover:bg-gray-700 transition-colors text-sm">
        <i class="fas fa-eraser mr-1"></i>Clear Display
      </button>
    </div>
  </div>
  
  <div class="relative" style="max-height: 70vh; overflow-y: auto;" id="log-container">
    <pre id="logbox" class="p-6 text-sm font-mono text-gray-300 whitespace-pre-wrap break-words bg-gray-950/30">Loading...</pre>
    
    <!-- Loading Indicator -->
    <div id="loading-indicator" class="hidden absolute top-4 right-4 bg-blue-500/20 border border-blue-500/50 text-blue-400 px-3 py-2 rounded-lg text-sm">
      <i class="fas fa-sync-alt fa-spin mr-2"></i>Refreshing...
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
let autoRefresh = true;
let refreshInterval;
let lastLogSize = 0;

async function refresh() {
  try {
    const loadingIndicator = document.getElementById('loading-indicator');
    loadingIndicator.classList.remove('hidden');
    
    const res = await fetch('/logs/{{ run_id }}/raw?_=' + Date.now());
    const txt = await res.text();
    
    const logbox = document.getElementById('logbox');
    const container = document.getElementById('log-container');
    const wasAtBottom = container.scrollTop + container.clientHeight >= container.scrollHeight - 50;
    
    logbox.textContent = txt;
    
    // Update size
    const size = new Blob([txt]).size;
    document.getElementById('log-size').textContent = formatBytes(size);
    
    // Auto-scroll if was at bottom
    if (wasAtBottom) {
      scrollToBottom();
    }
    
    // Highlight new content
    if (size > lastLogSize) {
      logbox.classList.add('flash-highlight');
      setTimeout(() => logbox.classList.remove('flash-highlight'), 500);
    }
    lastLogSize = size;
    
    loadingIndicator.classList.add('hidden');
  } catch (error) {
    console.error('Failed to refresh log:', error);
  }
}

function toggleAutoRefresh() {
  autoRefresh = !autoRefresh;
  const btn = document.getElementById('auto-refresh-btn');
  
  if (autoRefresh) {
    btn.className = 'px-4 py-2 bg-green-500/20 border border-green-500/50 text-green-400 rounded-lg hover:bg-green-500/30 transition-colors';
    btn.innerHTML = '<i class="fas fa-sync-alt mr-2"></i>Auto-refresh ON';
    startAutoRefresh();
  } else {
    btn.className = 'px-4 py-2 bg-gray-800 border border-gray-700 text-gray-400 rounded-lg hover:bg-gray-700 transition-colors';
    btn.innerHTML = '<i class="fas fa-pause mr-2"></i>Auto-refresh OFF';
    if (refreshInterval) {
      clearInterval(refreshInterval);
    }
  }
}

function startAutoRefresh() {
  if (refreshInterval) {
    clearInterval(refreshInterval);
  }
  refreshInterval = setInterval(() => {
    if (autoRefresh) {
      refresh();
    }
  }, 1500);
}

function scrollToBottom() {
  const container = document.getElementById('log-container');
  container.scrollTo({
    top: container.scrollHeight,
    behavior: 'smooth'
  });
}

function copyLog() {
  const logbox = document.getElementById('logbox');
  navigator.clipboard.writeText(logbox.textContent).then(() => {
    showToast('✓ Log copied to clipboard!');
  }).catch(err => {
    showToast('✗ Failed to copy log', 'error');
  });
}

function downloadLog() {
  const link = document.createElement('a');
  link.href = '/logs/{{ run_id }}/raw';
  link.download = '{{ run_id }}.log';
  link.click();
}

function clearLogDisplay() {
  document.getElementById('logbox').textContent = 'Display cleared (log file still exists)\n\nRefreshing in 3 seconds...';
  setTimeout(refresh, 3000);
}

function formatBytes(bytes) {
  if (bytes === 0) return '0 Bytes';
  const k = 1024;
  const sizes = ['Bytes', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

function showToast(message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = `fixed bottom-4 right-4 px-6 py-3 rounded-lg shadow-lg ${
    type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
  } z-50 animate-fade-in`;
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

// Initialize
startAutoRefresh();
refresh();

// Keyboard shortcuts
document.addEventListener('keydown', (e) => {
  if (e.key === 'r' && e.ctrlKey) {
    e.preventDefault();
    refresh();
  }
  if (e.key === 'End') {
    e.preventDefault();
    scrollToBottom();
  }
});
</script>

<style>
@keyframes flash-highlight {
  0%, 100% { background-color: rgba(17, 24, 39, 0.3); }
  50% { background-color: rgba(59, 130, 246, 0.1); }
}

.flash-highlight {
  animation: flash-highlight 0.5s ease-in-out;
}

@keyframes fade-in {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.animate-fade-in {
  animation: fade-in 0.3s ease-out;
}

/* Custom scrollbar */
#log-container::-webkit-scrollbar {
  width: 8px;
}

#log-container::-webkit-scrollbar-track {
  background: rgba(17, 24, 39, 0.5);
}

#log-container::-webkit-scrollbar-thumb {
  background: rgba(75, 85, 99, 0.5);
  border-radius: 4px;
}

#log-container::-webkit-scrollbar-thumb:hover {
  background: rgba(107, 114, 128, 0.7);
}
</style>
{% endblock %}
