{% extends "base.html" %}

{% block title %}Deploy: {{ script.name }} - Control Panel{% endblock %}

{% block content %}

<!-- Help Banner -->
<div class="glass rounded-xl p-4 border border-green-500/30 bg-green-500/10 mb-6">
  <div class="flex items-start gap-4">
    <div class="text-green-400 text-2xl">
      <i class="fas fa-cloud-upload-alt"></i>
    </div>
    <div class="flex-1">
      <h3 class="font-bold text-green-400 mb-2">Deploy to Remote VMs</h3>
      <p class="text-sm text-gray-300">
        This will <strong>upload the script to selected VMs</strong> via SSH. 
        The script runs on <strong>remote servers</strong>, not your local machine.
      </p>
      <div class="flex gap-6 mt-3 text-xs text-gray-400">
        <span><i class="fas fa-check text-green-500 mr-1"></i>Parallel upload</span>
        <span><i class="fas fa-check text-green-500 mr-1"></i>Auto chmod +x</span>
        <span><i class="fas fa-check text-green-500 mr-1"></i>Real-time results</span>
      </div>
    </div>
    <button onclick="this.parentElement.parentElement.style.display='none'" class="text-gray-400 hover:text-gray-200">
      <i class="fas fa-times"></i>
    </button>
  </div>
</div>

<!-- Header -->
<div class="mb-6">
  <div class="flex items-center gap-4 mb-4">
    <a href="/" class="px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg hover:bg-gray-700 transition-colors">
      <i class="fas fa-arrow-left mr-2"></i>Back
    </a>
    <div>
      <h2 class="text-2xl font-bold bg-gradient-to-r from-green-400 to-blue-500 bg-clip-text text-transparent">
        Deploy Script to VMs
      </h2>
      <p class="text-gray-400 text-sm mt-1">{{ script.name }}</p>
    </div>
  </div>

  <!-- Script Info -->
  <div class="glass rounded-xl border border-gray-700 p-6">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
      <div>
        <p class="text-gray-400 text-sm mb-2">Script Name</p>
        <p class="text-gray-200 font-semibold">{{ script.name }}</p>
      </div>
      <div>
        <p class="text-gray-400 text-sm mb-2">Path</p>
        <p class="text-gray-200 font-mono text-sm truncate">{{ script.path }}</p>
      </div>
      <div>
        <p class="text-gray-400 text-sm mb-2">Size</p>
        <p class="text-gray-200">{{ (script.size / 1024)|round(1) }} KB</p>
      </div>
    </div>
  </div>
</div>

{% if not vm_data %}
<!-- No VMs Configured -->
<div class="text-center py-16">
  <div class="glass rounded-xl p-12 border border-yellow-500/50 inline-block">
    <i class="fas fa-exclamation-triangle text-yellow-500 text-6xl mb-4"></i>
    <p class="text-gray-300 text-lg mb-2">No VMs Configured</p>
    <p class="text-gray-400 text-sm mb-6">You need to set up VM SSH Manager first</p>
    <div class="flex flex-col gap-2">
      <p class="text-gray-500 text-sm">Run these commands:</p>
      <pre class="bg-gray-950/50 p-4 rounded text-left text-sm"><code>vm init
vm add -n "server-1" -h "your-ip" -u root
vm list</code></pre>
      <a href="/" class="mt-4 px-6 py-2 bg-blue-500 hover:bg-blue-600 rounded-lg transition-colors inline-block">
        <i class="fas fa-arrow-left mr-2"></i>Back to Scripts
      </a>
    </div>
  </div>
</div>
{% elif vm_data.vms|length == 0 %}
<!-- Empty VMs -->
<div class="text-center py-16">
  <div class="glass rounded-xl p-12 border border-yellow-500/50 inline-block">
    <i class="fas fa-server text-yellow-500 text-6xl mb-4"></i>
    <p class="text-gray-300 text-lg mb-2">No VMs in Profile: {{ vm_data.profile_name }}</p>
    <p class="text-gray-400 text-sm mb-6">Add VMs to deploy scripts</p>
    <pre class="bg-gray-950/50 p-4 rounded text-left text-sm"><code>vm add -n "server-1" -h "your-ip" -u root</code></pre>
  </div>
</div>
{% else %}
<!-- Deploy Form -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
  <!-- Left: VM Selection -->
  <div class="lg:col-span-2">
    <div class="glass rounded-xl border border-gray-700 p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-gray-100">
          <i class="fas fa-server text-blue-400 mr-2"></i>
          Select Target VMs
        </h3>
        <div class="flex gap-2">
          <button onclick="selectAll()" class="px-3 py-1 text-sm bg-gray-800 hover:bg-gray-700 rounded transition-colors">
            Select All
          </button>
          <button onclick="selectNone()" class="px-3 py-1 text-sm bg-gray-800 hover:bg-gray-700 rounded transition-colors">
            Clear
          </button>
        </div>
      </div>

      <p class="text-gray-400 text-sm mb-4">
        Profile: <span class="text-blue-400">{{ vm_data.profile_name }}</span> ({{ vm_data.vms|length }} VMs)
      </p>

      <div class="space-y-2 max-h-96 overflow-y-auto">
        {% for vm in vm_data.vms %}
        <label class="flex items-center p-4 bg-gray-800/50 hover:bg-gray-800 rounded-lg cursor-pointer transition-colors group">
          <input 
            type="checkbox" 
            class="vm-checkbox w-5 h-5 rounded border-gray-600 text-blue-500 focus:ring-blue-500 focus:ring-offset-gray-900"
            value="{{ vm.name }}"
            data-host="{{ vm.host }}"
          />
          <div class="ml-4 flex-1">
            <div class="flex items-center justify-between">
              <span class="text-gray-200 font-semibold group-hover:text-blue-400 transition-colors">
                {{ vm.name }}
              </span>
              <span class="text-gray-500 text-sm">{{ vm.user }}@{{ vm.host }}:{{ vm.port|default(22) }}</span>
            </div>
            {% if vm.description %}
            <p class="text-gray-500 text-sm mt-1">{{ vm.description }}</p>
            {% endif %}
          </div>
        </label>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Right: Deploy Options & Action -->
  <div class="lg:col-span-1 space-y-4">
    <!-- Options -->
    <div class="glass rounded-xl border border-gray-700 p-6">
      <h3 class="text-lg font-semibold text-gray-100 mb-4">
        <i class="fas fa-cog text-purple-400 mr-2"></i>
        Deploy Options
      </h3>

      <div class="space-y-4">
        <!-- Destination Path -->
        <div>
          <label class="text-gray-400 text-sm block mb-2">Destination Path</label>
          <input 
            type="text" 
            id="dest-path" 
            value="/tmp/{{ script.name }}"
            class="w-full px-3 py-2 bg-gray-800 border border-gray-700 rounded-lg text-gray-100 focus:outline-none focus:border-blue-500 focus:ring-2 focus:ring-blue-500/20"
            placeholder="/path/on/vm"
          />
          <p class="text-gray-500 text-xs mt-1">Where to save the script on VMs</p>
        </div>

        <!-- Execute After Deploy -->
        <div class="flex items-center justify-between p-3 bg-gray-800/50 rounded-lg">
          <div>
            <p class="text-gray-200 text-sm font-medium">Execute After Deploy</p>
            <p class="text-gray-500 text-xs">Run script automatically</p>
          </div>
          <label class="relative inline-flex items-center cursor-pointer">
            <input type="checkbox" id="execute-toggle" class="sr-only peer">
            <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-500/20 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-500"></div>
          </label>
        </div>
      </div>
    </div>

    <!-- Deploy Button -->
    <div class="glass rounded-xl border border-green-500/50 bg-green-500/5 p-6">
      <button 
        onclick="deployScript()"
        id="deploy-btn"
        class="w-full px-6 py-3 bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-semibold rounded-lg transition-all duration-200 transform hover:scale-105 shadow-lg hover:shadow-green-500/50"
      >
        <i class="fas fa-rocket mr-2"></i>
        Deploy to VMs
      </button>
      <p class="text-gray-400 text-xs text-center mt-3">
        <span id="selected-count">0</span> VMs selected
      </p>
    </div>

    <!-- Quick Info -->
    <div class="glass rounded-xl border border-gray-700 p-6">
      <h4 class="text-sm font-semibold text-gray-300 mb-3">
        <i class="fas fa-info-circle text-blue-400 mr-2"></i>
        Deploy Info
      </h4>
      <ul class="space-y-2 text-sm text-gray-400">
        <li class="flex items-center gap-2">
          <i class="fas fa-check text-green-500"></i>
          Parallel deployment
        </li>
        <li class="flex items-center gap-2">
          <i class="fas fa-check text-green-500"></i>
          Auto chmod +x
        </li>
        <li class="flex items-center gap-2">
          <i class="fas fa-check text-green-500"></i>
          Progress tracking
        </li>
        <li class="flex items-center gap-2">
          <i class="fas fa-check text-green-500"></i>
          Error reporting
        </li>
      </ul>
    </div>
  </div>
</div>

<!-- Results Modal (Hidden by default) -->
<div id="results-modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
  <div class="glass rounded-xl border border-gray-700 max-w-4xl w-full max-h-[80vh] overflow-hidden flex flex-col">
    <!-- Modal Header -->
    <div class="p-6 border-b border-gray-700 flex items-center justify-between">
      <div>
        <h3 class="text-xl font-bold text-gray-100">Deployment Results</h3>
        <p class="text-gray-400 text-sm mt-1" id="results-summary"></p>
      </div>
      <button onclick="closeResults()" class="px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg transition-colors">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <!-- Modal Body -->
    <div class="p-6 overflow-y-auto flex-1" id="results-content">
      <!-- Results will be inserted here -->
    </div>

    <!-- Modal Footer -->
    <div class="p-6 border-t border-gray-700 flex justify-end gap-2">
      <button onclick="closeResults()" class="px-6 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg transition-colors">
        Close
      </button>
      <a href="/" class="px-6 py-2 bg-blue-500 hover:bg-blue-600 rounded-lg transition-colors">
        Back to Scripts
      </a>
    </div>
  </div>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
// Update selected count
function updateSelectedCount() {
  const count = document.querySelectorAll('.vm-checkbox:checked').length;
  document.getElementById('selected-count').textContent = count;
}

// Select all VMs
function selectAll() {
  document.querySelectorAll('.vm-checkbox').forEach(cb => cb.checked = true);
  updateSelectedCount();
}

// Clear selection
function selectNone() {
  document.querySelectorAll('.vm-checkbox').forEach(cb => cb.checked = false);
  updateSelectedCount();
}

// Listen for checkbox changes
document.querySelectorAll('.vm-checkbox').forEach(cb => {
  cb.addEventListener('change', updateSelectedCount);
});

// Deploy script
async function deployScript() {
  const selectedVMs = Array.from(document.querySelectorAll('.vm-checkbox:checked'))
    .map(cb => cb.value);

  if (selectedVMs.length === 0) {
    alert('‚ö†Ô∏è Please select at least one VM');
    return;
  }

  const destPath = document.getElementById('dest-path').value;
  const execute = document.getElementById('execute-toggle').checked;

  if (!confirm(
    `üåê Deploy to Remote VMs\n\n` +
    `Script: {{ script.name }}\n` +
    `Target VMs: ${selectedVMs.length} servers\n` +
    `Destination: ${destPath}\n` +
    `Execute after upload: ${execute ? 'Yes' : 'No'}\n\n` +
    `This will upload the script to remote servers via SSH.\n\n` +
    `Continue?`
  )) {
    return;
  }

  const btn = document.getElementById('deploy-btn');
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Deploying...';

  try {
    const response = await fetch('/api/deploy', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        script_path: '{{ script.path }}',
        vm_names: selectedVMs,
        dest_path: destPath,
        execute: execute
      })
    });

    const data = await response.json();

    if (!response.ok) {
      throw new Error(data.error || 'Deployment failed');
    }

    // Show results
    showResults(data);
  } catch (error) {
    alert(`‚ùå Deployment failed: ${error.message}`);
    console.error(error);
  } finally {
    btn.disabled = false;
    btn.innerHTML = '<i class="fas fa-rocket mr-2"></i>Deploy to VMs';
  }
}

// Show results in modal
function showResults(data) {
  const modal = document.getElementById('results-modal');
  const summary = document.getElementById('results-summary');
  const content = document.getElementById('results-content');

  // Update summary
  summary.textContent = `${data.summary.succeeded} succeeded, ${data.summary.failed} failed out of ${data.summary.total} VMs`;

  // Build results HTML
  let html = '<div class="space-y-4">';
  
  data.results.forEach(result => {
    const bgColor = result.success ? 'bg-green-500/10' : 'bg-red-500/10';
    const borderColor = result.success ? 'border-green-500/30' : 'border-red-500/30';
    const icon = result.success ? 'fa-check-circle text-green-400' : 'fa-times-circle text-red-400';
    
    html += `
      <div class="p-4 ${bgColor} border ${borderColor} rounded-lg">
        <div class="flex items-start gap-3">
          <i class="fas ${icon} text-2xl mt-1"></i>
          <div class="flex-1">
            <div class="flex items-center justify-between mb-2">
              <h4 class="text-gray-100 font-semibold">${result.vm}</h4>
              <span class="text-gray-400 text-sm">${result.host}</span>
            </div>
            ${result.success ? `
              <pre class="bg-gray-950/50 p-3 rounded text-xs text-gray-300 overflow-x-auto">${result.output}</pre>
            ` : `
              <p class="text-red-400 text-sm">${result.error}</p>
            `}
          </div>
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  
  content.innerHTML = html;
  modal.classList.remove('hidden');
}

// Close results modal
function closeResults() {
  document.getElementById('results-modal').classList.add('hidden');
}

// Close modal on ESC key
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closeResults();
  }
});

// Initial count
updateSelectedCount();
</script>
{% endblock %}

