# Dockerfile Optimizer Report

**Score:** 10/100 (F) | **Estimated size:** -190MB | **Build steps:** --1 layers

## Findings (8)

| Severity | Count |
|----------|-------|
| 🔴 HIGH | 2 |
| 🟡 MEDIUM | 4 |
| 🔵 LOW | 2 |

### 🔴 HIGH Priority

1. **Base image 'node:18' is not pinned with digest**
   - Pinning base images with SHA256 digest ensures reproducible builds and prevents unexpected changes.
   - 💡 **Fix:** Pin the image: FROM node:18@sha256:... 

2. **Consider using multi-stage build to separate build and runtime environments**
   - Single-stage builds include build tools in the final image, increasing size and attack surface.
   - 💡 **Fix:** Split into builder stage (with build tools) and runtime stage (minimal, with only artifacts)

### 🟡 MEDIUM Priority

1. **Consecutive package manager RUN commands should be consolidated**
   - Multiple RUN commands create separate layers. Consolidating reduces layer count.
   - 💡 **Fix:** Combine into single RUN with && operator and clean up cache in same layer

2. **COPY . . before dependency installation breaks cache**
   - Copying all files before installing dependencies means cache invalidates on any code change.
   - 💡 **Fix:** Copy dependency files (package.json, go.mod, etc.) first, install dependencies, then copy source code

3. **Container runs as root user**
   - Running containers as root increases security risk. Use a dedicated non-root user.
   - 💡 **Fix:** Add USER directive with non-root user (e.g., USER 10001 or USER node)

4. **apt-get install without cleaning cache**
   - APT cache adds unnecessary size to the image layer.
   - 💡 **Fix:** Add to same RUN: && apt-get clean && rm -rf /var/lib/apt/lists/*

### 🔵 LOW Priority

1. **apt-get install without pinned versions**
   - Unpinned package versions can lead to non-reproducible builds.
   - 💡 **Fix:** Pin versions: apt-get install package=version

2. **No .dockerignore file detected**
   - Without .dockerignore, unnecessary files (node_modules, .git, etc.) are sent to build context.
   - 💡 **Fix:** Create .dockerignore with common exclusions

---

## 📊 Metrics

| Metric | Value |
|--------|-------|
| Estimated Size Savings | 190 MB |
| Layer Reduction | -1 |
| Build Time Improvement | 0% |
| Cache Efficiency | 80/100 |
| Security Score | 85/100 |

## 📝 Patch (Unified Diff)

```diff
Index: Dockerfile
===================================================================
--- Dockerfile	original
+++ Dockerfile	optimized
@@ -1,20 +1,31 @@
 # Example of a non-optimized Dockerfile with many issues
-FROM node:18
+# TODO: Pin with digest - run: docker pull node:18 && docker inspect node:18 | grep -i digest
+FROM node:18 AS builder
 WORKDIR /app
+COPY package*.json ./
+# Install dependencies first for better caching
 
 # Bad: Copy everything before installing dependencies (breaks cache)
-COPY . .
 
 # Bad: Not using npm ci, separate RUN commands
+
+COPY . .
 RUN npm install
 RUN npm run build
 
 # Bad: No cleanup of cache
-RUN apt-get update
-RUN apt-get install -y curl wget
-
+RUN apt-get update && \
+    apt-get install -y curl wget
 EXPOSE 3000
 
 # Bad: Running as root
+
+# Runtime stage
+FROM node:18-slim
+WORKDIR /app
+COPY --from=builder /app /app
+
+# Run as non-root user
+USER 10001
 CMD ["npm", "start"]
 

```

---

*Generated by Dockerfile Optimizer*
